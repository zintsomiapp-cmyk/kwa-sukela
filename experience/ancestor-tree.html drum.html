<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Drum Circle ¬∑ Izwi Lezindaba ¬∑ Kwa Sukela</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Syne:wght@600;700;800&family=DM+Sans:opsz,wght@9..40,400;9..40,500&display=swap" rel="stylesheet">
<style>
:root{
  --night:#080502;--ember:#140A03;--coal:#1E1005;
  --paper:#FAF6EE;
  --fire:#E8540A;--fire-l:#F97316;--fire-xl:#FBA94C;
  --gold:#C4820A;--gold-xl:#F5C842;
  --teal:#0F9488;--teal-glow:#14E8C8;
  --crimson:#9B1C1C;--earth:#7C3B0F;
  --ink:rgba(250,246,238,.85);--ink-m:rgba(250,246,238,.5);--ink-l:rgba(250,246,238,.25);
}
*{margin:0;padding:0;box-sizing:border-box;}
html{font-size:16px;}
body{
  background:var(--night);
  font-family:'DM Sans',sans-serif;
  color:var(--paper);
  overflow-x:hidden;
  cursor:none;
  min-height:100vh;
  display:flex;flex-direction:column;
}

/* ‚îÄ‚îÄ CURSOR ‚îÄ‚îÄ */
#cur{width:12px;height:12px;border-radius:50%;background:var(--fire-l);position:fixed;top:0;left:0;pointer-events:none;z-index:9999;transform:translate(-50%,-50%);box-shadow:0 0 14px var(--fire-l);transition:transform .08s,width .12s,height .12s;}
#ring{width:36px;height:36px;border-radius:50%;border:2px solid rgba(249,115,22,.55);position:fixed;top:0;left:0;pointer-events:none;z-index:9998;transform:translate(-50%,-50%);transition:width .3s cubic-bezier(.22,1,.36,1),height .3s cubic-bezier(.22,1,.36,1);}
#cur.hit{transform:translate(-50%,-50%) scale(2.5);background:var(--gold-xl);}
@media(max-width:768px){#cur,#ring{display:none;}}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav{position:fixed;top:0;left:0;right:0;z-index:500;background:rgba(8,5,2,.92);backdrop-filter:blur(16px);border-bottom:1px solid rgba(250,246,238,.05);}
.ndebele{height:4px;background:repeating-linear-gradient(90deg,var(--fire) 0,var(--fire) 14.28%,var(--gold-xl) 14.28%,var(--gold-xl) 28.57%,var(--night) 28.57%,var(--night) 42.85%,var(--teal-glow) 42.85%,var(--teal-glow) 57.14%,var(--earth) 57.14%,var(--earth) 71.42%,var(--crimson) 71.42%,var(--crimson) 85.71%,var(--paper) 85.71%,var(--paper) 100%);}
.nav-inner{max-width:1100px;margin:0 auto;padding:.75rem 2rem;display:flex;justify-content:space-between;align-items:center;}
.nav-logo{font-family:'Cormorant Garamond',serif;font-size:1.15rem;font-weight:700;color:var(--paper);text-decoration:none;}
.nav-logo em{font-style:italic;color:var(--fire-l);}
.nav-right{display:flex;gap:1rem;align-items:center;}
.nav-link{font-family:'Syne',sans-serif;font-size:.6rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--ink-m);text-decoration:none;transition:color .2s;}
.nav-link:hover{color:var(--fire-xl);}
.nav-cta{font-family:'Syne',sans-serif;font-size:.6rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:.42rem 1rem;background:var(--fire);color:var(--paper);text-decoration:none;border-radius:2px;}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
main{flex:1;padding:5rem 1.5rem 3rem;display:flex;flex-direction:column;align-items:center;gap:3rem;max-width:900px;margin:0 auto;width:100%;}

/* ‚îÄ‚îÄ HERO TEXT ‚îÄ‚îÄ */
.page-hero{text-align:center;}
.ph-eyebrow{
  font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;
  letter-spacing:.2em;text-transform:uppercase;
  color:var(--fire-xl);margin-bottom:.8rem;
  display:flex;align-items:center;justify-content:center;gap:.8rem;
}
.ph-eyebrow::before,.ph-eyebrow::after{content:'';width:28px;height:1px;background:var(--fire);}
.ph-title{
  font-family:'Cormorant Garamond',serif;
  font-size:clamp(2.4rem,7vw,5rem);
  font-weight:700;color:var(--paper);
  line-height:.9;letter-spacing:-.02em;
  margin-bottom:.8rem;
}
.ph-title em{font-style:italic;color:var(--fire-xl);}
.ph-sub{
  font-size:1rem;color:var(--ink-m);line-height:1.75;
  max-width:500px;margin:0 auto;
}
.ph-sub strong{color:var(--fire-xl);font-weight:500;}

/* ‚îÄ‚îÄ VISUALISER ‚îÄ‚îÄ */
.vis-wrap{
  width:100%;position:relative;
  background:radial-gradient(ellipse at 50% 50%,rgba(232,84,10,.06) 0%,transparent 65%),var(--ember);
  border:1px solid rgba(250,246,238,.06);
  border-radius:4px;overflow:hidden;
}
#visCanvas{display:block;width:100%;height:180px;}

/* ‚îÄ‚îÄ DRUM INSTRUMENT ‚îÄ‚îÄ */
.drum-section{
  display:flex;flex-direction:column;align-items:center;gap:1.5rem;
  width:100%;
}

/* Drum selector tabs */
.drum-tabs{
  display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;
}
.drum-tab{
  font-family:'Syne',sans-serif;font-size:.6rem;font-weight:700;
  letter-spacing:.1em;text-transform:uppercase;
  padding:.4rem 1rem;border-radius:40px;
  border:1px solid rgba(250,246,238,.12);
  background:none;color:var(--ink-l);cursor:none;
  transition:all .2s;
}
.drum-tab:hover,.drum-tab.active{
  border-color:rgba(232,84,10,.5);color:var(--fire-xl);background:rgba(232,84,10,.08);
}

/* The drum face */
.drum-stage{display:flex;align-items:center;justify-content:center;gap:2rem;flex-wrap:wrap;}

.drum-wrap{
  position:relative;display:flex;flex-direction:column;align-items:center;gap:.6rem;
  user-select:none;-webkit-user-select:none;
}
.drum{
  width:clamp(100px,18vw,150px);
  height:clamp(100px,18vw,150px);
  border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  cursor:none;
  position:relative;
  transition:transform .06s;
  -webkit-tap-highlight-color:transparent;
}
.drum:active,.drum.hit{transform:scale(.92);}

/* Djembe */
.djembe{
  background:radial-gradient(circle at 40% 35%,#3A1A06,#1A0803);
  border:3px solid #2A1004;
  box-shadow:0 0 0 6px rgba(232,84,10,.15),0 8px 32px rgba(0,0,0,.6),inset 0 2px 8px rgba(255,200,100,.08);
}
.djembe-inner{
  width:70%;height:70%;border-radius:50%;
  background:radial-gradient(circle at 45% 40%,#4A2208,#1A0803);
  border:2px solid rgba(232,84,10,.3);
  display:flex;align-items:center;justify-content:center;
}

/* Bass drum */
.bass{
  background:radial-gradient(circle at 40% 35%,#1A0E03,#0A0602);
  border:4px solid #140A02;
  box-shadow:0 0 0 8px rgba(196,130,10,.12),0 8px 40px rgba(0,0,0,.7),inset 0 2px 10px rgba(255,200,50,.06);
}
.bass-inner{
  width:65%;height:65%;border-radius:50%;
  background:radial-gradient(circle at 45% 40%,#28180A,#0A0602);
  border:2px solid rgba(196,130,10,.3);
  display:flex;align-items:center;justify-content:center;
}

/* Snare */
.snare{
  background:radial-gradient(circle at 40% 35%,#2A1E0A,#120C03);
  border:3px solid #1C1404;
  box-shadow:0 0 0 5px rgba(245,200,66,.1),0 6px 28px rgba(0,0,0,.6),inset 0 2px 6px rgba(255,220,100,.06);
}
.snare-inner{
  width:72%;height:72%;border-radius:50%;
  background:radial-gradient(circle at 45% 40%,#382A10,#120C03);
  border:2px solid rgba(245,200,66,.25);
  display:flex;align-items:center;justify-content:center;
}

/* Hit ripple */
.hit-ring{
  position:absolute;top:50%;left:50%;
  width:100%;height:100%;
  border-radius:50%;
  border:2px solid rgba(232,84,10,.6);
  transform:translate(-50%,-50%) scale(0);
  pointer-events:none;
  animation:none;
}
.hit-ring.pop{animation:ringPop .5s ease forwards;}
@keyframes ringPop{
  0%{transform:translate(-50%,-50%) scale(.7);opacity:.8;}
  100%{transform:translate(-50%,-50%) scale(1.8);opacity:0;}
}

.drum-label{
  font-family:'Syne',sans-serif;font-size:.56rem;font-weight:700;
  letter-spacing:.1em;text-transform:uppercase;color:var(--ink-l);
}
.drum-key{
  font-family:'Cormorant Garamond',serif;font-size:.8rem;font-style:italic;
  color:var(--ink-l);
}

/* ‚îÄ‚îÄ PATTERN RECORDER ‚îÄ‚îÄ */
.recorder{
  width:100%;
  background:var(--ember);border:1px solid rgba(250,246,238,.06);
  border-radius:3px;padding:1.5rem;
}
.rec-header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;flex-wrap:gap;gap:.8rem;
}
.rec-title{
  font-family:'Syne',sans-serif;font-size:.65rem;font-weight:700;
  letter-spacing:.14em;text-transform:uppercase;
  color:var(--ink-m);display:flex;align-items:center;gap:.6rem;
}
.rec-dot{
  width:8px;height:8px;border-radius:50%;
  background:rgba(250,246,238,.2);
}
.rec-dot.recording{
  background:var(--fire);
  animation:recPulse 1s ease-in-out infinite;
}
@keyframes recPulse{0%,100%{box-shadow:0 0 0 0 rgba(232,84,10,.5);}50%{box-shadow:0 0 0 6px rgba(232,84,10,0);}}
.rec-btns{display:flex;gap:.6rem;flex-wrap:wrap;}
.rec-btn{
  font-family:'Syne',sans-serif;font-size:.6rem;font-weight:700;
  letter-spacing:.1em;text-transform:uppercase;
  padding:.45rem .9rem;border-radius:2px;border:none;cursor:none;
  transition:all .2s;
}
.btn-record{background:var(--fire);color:var(--paper);}
.btn-record:hover{background:var(--fire-l);}
.btn-stop{background:rgba(250,246,238,.08);color:var(--ink-m);border:1px solid rgba(250,246,238,.1);}
.btn-stop:hover{border-color:rgba(250,246,238,.3);color:var(--ink);}
.btn-play{background:rgba(20,232,200,.1);color:var(--teal-glow);border:1px solid rgba(20,232,200,.25);}
.btn-play:hover{background:rgba(20,232,200,.2);}
.btn-save{background:var(--gold);color:var(--paper);}
.btn-save:hover{background:var(--gold-xl);color:var(--night);}

/* Pattern grid */
.pattern-grid{
  display:flex;flex-direction:column;gap:.4rem;
  margin-top:.8rem;
}
.pattern-row{display:flex;gap:.3rem;align-items:center;}
.pattern-row-label{
  font-family:'Syne',sans-serif;font-size:.5rem;font-weight:700;
  letter-spacing:.08em;text-transform:uppercase;
  color:var(--ink-l);width:48px;flex-shrink:0;
}
.pattern-beats{display:flex;gap:.3rem;flex:1;flex-wrap:wrap;}
.beat{
  width:22px;height:22px;border-radius:3px;
  background:rgba(250,246,238,.04);border:1px solid rgba(250,246,238,.08);
  transition:background .15s,border-color .15s;
  flex-shrink:0;
}
.beat.on{background:var(--fire);border-color:var(--fire-l);}
.beat.current{border-color:rgba(20,232,200,.6);}
.beat.on.current{background:var(--fire-l);box-shadow:0 0 8px rgba(232,84,10,.5);}

/* ‚îÄ‚îÄ COMMUNITY RHYTHMS ‚îÄ‚îÄ */
.community{width:100%;}
.comm-header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;
}
.comm-title{
  font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:700;color:var(--paper);
}
.comm-count{
  font-family:'Syne',sans-serif;font-size:.6rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;
  color:var(--teal-glow);
}
.rhythms-list{display:flex;flex-direction:column;gap:.6rem;}
.rhythm-item{
  display:flex;align-items:center;gap:1rem;
  padding:1rem;
  background:var(--ember);border:1px solid rgba(250,246,238,.06);border-radius:2px;
  border-left:3px solid transparent;
  transition:border-color .2s;cursor:none;
}
.rhythm-item:hover{border-color:var(--fire);}
.ri-play{
  width:36px;height:36px;border-radius:50%;
  background:rgba(232,84,10,.1);border:1px solid rgba(232,84,10,.3);
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
  cursor:none;transition:all .2s;
}
.ri-play:hover{background:rgba(232,84,10,.25);}
.ri-play svg{width:12px;height:12px;fill:var(--fire-l);}
.ri-info{flex:1;}
.ri-name{font-family:'Cormorant Garamond',serif;font-size:1rem;color:var(--paper);margin-bottom:.15rem;}
.ri-meta{font-family:'Syne',sans-serif;font-size:.52rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--ink-l);}
.ri-pattern{
  display:flex;gap:2px;
}
.ri-beat{width:10px;height:16px;border-radius:1px;background:rgba(250,246,238,.06);}
.ri-beat.on{background:var(--fire);}
.ri-beat.on2{background:var(--gold-xl);}
.ri-beat.on3{background:var(--teal-glow);}

/* ‚îÄ‚îÄ SAVE MODAL ‚îÄ‚îÄ */
#saveModal{
  position:fixed;inset:0;z-index:200;
  background:rgba(8,5,2,.85);backdrop-filter:blur(16px);
  display:none;align-items:center;justify-content:center;padding:1.5rem;
}
#saveModal.show{display:flex;animation:fadeIn .3s ease;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.save-card{
  background:var(--coal);border:1px solid rgba(232,84,10,.25);border-radius:4px;
  padding:2.5rem;max-width:400px;width:100%;
}
.sc-strip{height:4px;background:repeating-linear-gradient(90deg,var(--fire) 0,var(--fire) 25%,var(--gold-xl) 25%,var(--gold-xl) 50%,var(--teal-glow) 50%,var(--teal-glow) 75%,var(--crimson) 75%,var(--crimson) 100%);margin:-2.5rem -2.5rem 2rem;border-radius:4px 4px 0 0;}
.sc-title{font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:700;color:var(--paper);margin-bottom:.3rem;}
.sc-sub{font-family:'Syne',sans-serif;font-size:.6rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--teal-glow);margin-bottom:1.5rem;}
.sc-label{font-family:'Syne',sans-serif;font-size:.56rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--ink-l);margin-bottom:.4rem;display:block;}
.sc-input{width:100%;padding:.75rem 1rem;background:rgba(250,246,238,.05);border:1px solid rgba(250,246,238,.1);border-radius:2px;color:var(--paper);font-family:'DM Sans',sans-serif;font-size:.95rem;outline:none;margin-bottom:1rem;transition:border-color .2s;}
.sc-input:focus{border-color:rgba(232,84,10,.5);}
.sc-input::placeholder{color:rgba(250,246,238,.2);}
.sc-btns{display:flex;gap:.8rem;margin-top:.5rem;}
.sc-confirm{flex:1;font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:.75rem 1.2rem;background:var(--fire);color:var(--paper);border:none;border-radius:2px;cursor:none;transition:all .2s;}
.sc-confirm:hover{background:var(--fire-l);}
.sc-cancel{font-family:'Syne',sans-serif;font-size:.65rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:.75rem 1rem;background:none;border:1px solid rgba(250,246,238,.12);color:var(--ink-l);border-radius:2px;cursor:none;transition:all .2s;}
.sc-cancel:hover{border-color:rgba(250,246,238,.3);color:var(--ink-m);}

@media(max-width:600px){
  .drum-stage{gap:1rem;}
  .drum{width:90px;height:90px;}
  .beat{width:16px;height:16px;}
}
</style>
</head>
<body>

<div id="cur"></div>
<div id="ring"></div>

<nav>
  <div class="ndebele"></div>
  <div class="nav-inner">
    <a href="index.html" class="nav-logo">Kwa <em>Sukela</em></a>
    <div class="nav-right">
      <a href="ancestor-tree.html" class="nav-link">Ancestor Tree</a>
      <a href="vr-world.html" class="nav-link">VR World</a>
      <a href="index.html#enrol" class="nav-cta">Enrol</a>
    </div>
  </div>
</nav>

<main>

  <!-- Hero -->
  <div class="page-hero">
    <div class="ph-eyebrow">African Rhythm ¬∑ Ubuntu Soundscape</div>
    <h1 class="ph-title">The Drum <em>Circle</em></h1>
    <p class="ph-sub">
      Beat your rhythm. Save it. It joins the <strong>collective soundscape</strong> ‚Äî a living drum circle built from every visitor who came before you. <strong>Your beat plays alongside theirs. Forever.</strong>
    </p>
  </div>

  <!-- Visualiser -->
  <div class="vis-wrap" style="width:100%;">
    <canvas id="visCanvas"></canvas>
  </div>

  <!-- Drum instruments -->
  <div class="drum-section">
    <div class="drum-tabs">
      <button class="drum-tab active" data-set="djembe">Djembe</button>
      <button class="drum-tab" data-set="bass">Bass Drum</button>
      <button class="drum-tab" data-set="full">Full Circle</button>
    </div>

    <!-- Djembe set (default) -->
    <div class="drum-stage" id="djembe-set">
      <!-- Bass (low tone) -->
      <div class="drum-wrap">
        <div class="drum djembe" id="drum-bass" data-drum="bass" data-freq="80" data-type="triangle">
          <div class="djembe-inner">
            <span style="font-family:'Cormorant Garamond',serif;font-size:1.2rem;color:rgba(250,246,238,.3);">B</span>
          </div>
          <div class="hit-ring"></div>
        </div>
        <div class="drum-label">Bass</div>
        <div class="drum-key">Key: J</div>
      </div>

      <!-- Tone (mid) -->
      <div class="drum-wrap">
        <div class="drum djembe" id="drum-tone" data-drum="tone" data-freq="200" data-type="sine" style="width:clamp(120px,20vw,170px);height:clamp(120px,20vw,170px);">
          <div class="djembe-inner" style="width:65%;height:65%;">
            <span style="font-family:'Cormorant Garamond',serif;font-size:1.5rem;color:rgba(250,246,238,.3);">T</span>
          </div>
          <div class="hit-ring"></div>
        </div>
        <div class="drum-label">Tone</div>
        <div class="drum-key">Key: Space</div>
      </div>

      <!-- Slap (high) -->
      <div class="drum-wrap">
        <div class="drum djembe" id="drum-slap" data-drum="slap" data-freq="350" data-type="sawtooth" style="width:clamp(80px,14vw,120px);height:clamp(80px,14vw,120px);">
          <div class="djembe-inner" style="width:60%;height:60%;">
            <span style="font-family:'Cormorant Garamond',serif;font-size:1rem;color:rgba(250,246,238,.3);">S</span>
          </div>
          <div class="hit-ring"></div>
        </div>
        <div class="drum-label">Slap</div>
        <div class="drum-key">Key: K</div>
      </div>
    </div>

    <!-- Full circle set (hidden) -->
    <div class="drum-stage" id="full-set" style="display:none;">
      <div class="drum-wrap">
        <div class="drum djembe" data-drum="djembe1" data-freq="80" data-type="triangle">
          <div class="djembe-inner"></div><div class="hit-ring"></div>
        </div>
        <div class="drum-label">Djembe Bass</div>
      </div>
      <div class="drum-wrap">
        <div class="drum bass" data-drum="bass1" data-freq="55" data-type="sine" style="width:clamp(110px,18vw,160px);height:clamp(110px,18vw,160px);">
          <div class="bass-inner"></div><div class="hit-ring"></div>
        </div>
        <div class="drum-label">Dundun</div>
      </div>
      <div class="drum-wrap">
        <div class="drum snare" data-drum="snare1" data-freq="300" data-type="square">
          <div class="snare-inner"></div><div class="hit-ring"></div>
        </div>
        <div class="drum-label">Talking Drum</div>
      </div>
      <div class="drum-wrap">
        <div class="drum djembe" data-drum="slap1" data-freq="450" data-type="sawtooth" style="width:clamp(70px,12vw,100px);height:clamp(70px,12vw,100px);">
          <div class="djembe-inner"></div><div class="hit-ring"></div>
        </div>
        <div class="drum-label">Shaker</div>
      </div>
    </div>
  </div>

  <!-- Pattern Recorder -->
  <div class="recorder" style="width:100%;">
    <div class="rec-header">
      <div class="rec-title">
        <div class="rec-dot" id="recDot"></div>
        <span id="recStatus">Ready to record</span>
      </div>
      <div class="rec-btns">
        <button class="rec-btn btn-record" onclick="startRecord()">‚è∫ Record</button>
        <button class="rec-btn btn-stop" onclick="stopRecord()">‚èπ Stop</button>
        <button class="rec-btn btn-play" onclick="playPattern()">‚ñ∂ Play</button>
        <button class="rec-btn btn-save" onclick="showSave()">üíæ Save to Circle</button>
      </div>
    </div>

    <!-- 16-step pattern grid -->
    <div class="pattern-grid" id="patternGrid">
      <div class="pattern-row">
        <span class="pattern-row-label">Bass</span>
        <div class="pattern-beats" id="beats-bass"></div>
      </div>
      <div class="pattern-row">
        <span class="pattern-row-label">Tone</span>
        <div class="pattern-beats" id="beats-tone"></div>
      </div>
      <div class="pattern-row">
        <span class="pattern-row-label">Slap</span>
        <div class="pattern-beats" id="beats-slap"></div>
      </div>
    </div>
  </div>

  <!-- Community rhythms -->
  <div class="community" style="width:100%;">
    <div class="comm-header">
      <div class="comm-title">The Circle's Rhythms</div>
      <div class="comm-count" id="commCount">0 rhythms saved</div>
    </div>
    <div class="rhythms-list" id="rhythmsList"></div>
  </div>

</main>

<!-- Save modal -->
<div id="saveModal">
  <div class="save-card">
    <div class="sc-strip"></div>
    <div class="sc-title">Join the Circle</div>
    <div class="sc-sub">Your rhythm plays alongside every visitor's forever</div>
    <label class="sc-label">Your name</label>
    <input class="sc-input" id="rhythm-name" type="text" placeholder="Bongani, Nokwanda, Thabo‚Ä¶" maxlength="40">
    <label class="sc-label">Your instrument / tradition (optional)</label>
    <input class="sc-input" id="rhythm-instrument" type="text" placeholder="Djembe ¬∑ Western Cape ¬∑ Xhosa tradition‚Ä¶" maxlength="60">
    <div class="sc-btns">
      <button class="sc-cancel" onclick="hideSave()">Cancel</button>
      <button class="sc-confirm" onclick="saveRhythm()">Join the Circle ü•Å</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê WEB AUDIO ENGINE ‚ïê‚ïê
let audioCtx = null;
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

// Beat a drum ‚Äî synthesised African drum sounds
function beatDrum(freq, type, drumName) {
  const ac = getAudioCtx();
  const now = ac.currentTime;

  // Oscillator for tone
  const osc = ac.createOscillator();
  const gain = ac.createGain();
  const filter = ac.createBiquadFilter();

  // Pitch envelope (drop) ‚Äî characteristic of membrane drums
  osc.type = type || 'triangle';
  osc.frequency.setValueAtTime(freq * 2.5, now);
  osc.frequency.exponentialRampToValueAtTime(freq, now + .08);
  osc.frequency.exponentialRampToValueAtTime(freq * .3, now + .35);

  // Volume envelope ‚Äî sharp attack, natural decay
  gain.gain.setValueAtTime(0, now);
  gain.gain.linearRampToValueAtTime(.85, now + .005);
  gain.gain.exponentialRampToValueAtTime(.001, now + (drumName === 'bass' || drumName === 'bass1' ? .6 : .35));

  // Filter for warmth
  filter.type = 'lowpass';
  filter.frequency.setValueAtTime(drumName === 'slap' || drumName === 'slap1' ? 1200 : 600, now);
  filter.Q.value = 1;

  // Noise layer for attack transient
  const bufSize = ac.sampleRate * .05;
  const noiseBuf = ac.createBuffer(1, bufSize, ac.sampleRate);
  const data = noiseBuf.getChannelData(0);
  for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1);
  const noiseSource = ac.createBufferSource();
  noiseSource.buffer = noiseBuf;
  const noiseGain = ac.createGain();
  const noiseFilter = ac.createBiquadFilter();
  noiseFilter.type = 'bandpass';
  noiseFilter.frequency.value = freq * 3;
  noiseFilter.Q.value = .5;
  noiseGain.gain.setValueAtTime(.3, now);
  noiseGain.gain.exponentialRampToValueAtTime(.001, now + .04);
  noiseSource.connect(noiseFilter);
  noiseFilter.connect(noiseGain);
  noiseGain.connect(ac.destination);
  noiseSource.start(now);
  noiseSource.stop(now + .05);

  osc.connect(filter);
  filter.connect(gain);
  gain.connect(ac.destination);
  osc.start(now);
  osc.stop(now + .65);

  // Feed to visualiser
  gain.connect(analyser);
}

// ‚ïê‚ïê VISUALISER ‚ïê‚ïê
const visCanvas = document.getElementById('visCanvas');
const vCtx = visCanvas.getContext('2d');
let analyser;

function initAnalyser() {
  const ac = getAudioCtx();
  analyser = ac.createAnalyser();
  analyser.fftSize = 256;
  analyser.connect(ac.destination);
}

function resizeVis() {
  visCanvas.width = visCanvas.offsetWidth;
  visCanvas.height = visCanvas.offsetHeight;
}
resizeVis();
window.addEventListener('resize', resizeVis, { passive: true });

let visData = new Uint8Array(128);
function drawVis() {
  if (analyser) analyser.getByteFrequencyData(visData);
  const W = visCanvas.width, H = visCanvas.height;
  vCtx.clearRect(0, 0, W, H);

  // Background
  vCtx.fillStyle = 'rgba(8,5,2,.4)';
  vCtx.fillRect(0, 0, W, H);

  const barW = W / visData.length * 2.5;
  for (let i = 0; i < visData.length; i++) {
    const v = visData[i] / 255;
    const barH = v * H * .85;
    const x = i * (W / visData.length);

    // Color gradient based on frequency
    const hue = i < 20 ? 'rgba(232,84,10,' : i < 50 ? 'rgba(245,200,66,' : 'rgba(20,232,200,';
    const grd = vCtx.createLinearGradient(0, H - barH, 0, H);
    grd.addColorStop(0, hue + (v * .9 + .1) + ')');
    grd.addColorStop(1, hue + '0.05)');
    vCtx.fillStyle = grd;
    vCtx.fillRect(x, H - barH, barW - 1, barH);
  }

  // Centre line
  vCtx.beginPath();
  vCtx.moveTo(0, H / 2);
  vCtx.lineTo(W, H / 2);
  vCtx.strokeStyle = 'rgba(250,246,238,.04)';
  vCtx.lineWidth = 1;
  vCtx.stroke();

  requestAnimationFrame(drawVis);
}

// ‚ïê‚ïê DRUM EVENTS ‚ïê‚ïê
function hitDrum(el) {
  const freq = parseFloat(el.getAttribute('data-freq'));
  const type = el.getAttribute('data-type');
  const name = el.getAttribute('data-drum');

  if (!analyser) initAnalyser();
  beatDrum(freq, type, name);

  // Visual feedback
  el.classList.add('hit');
  const ring = el.querySelector('.hit-ring');
  ring.classList.remove('pop');
  void ring.offsetWidth;
  ring.classList.add('pop');
  setTimeout(() => el.classList.remove('hit'), 120);

  // Cursor flash
  document.getElementById('cur').classList.add('hit');
  setTimeout(() => document.getElementById('cur').classList.remove('hit'), 120);

  // Record if recording
  if (isRecording) {
    const elapsed = Date.now() - recordStart;
    recordedHits.push({ drum: name, time: elapsed });
    // Update pattern grid
    const beatIndex = Math.floor((elapsed / (60000 / bpm)) % BEATS) | 0;
    const beatEl = document.querySelector(`#beats-${name.replace(/\d/g, '')} .beat:nth-child(${beatIndex + 1})`);
    if (beatEl) beatEl.classList.add('on');
  }
}

// Bind all drums
document.querySelectorAll('.drum').forEach(drum => {
  drum.addEventListener('mousedown', () => hitDrum(drum));
  drum.addEventListener('touchstart', e => { e.preventDefault(); hitDrum(drum); }, { passive: false });
});

// Keyboard
const keyMap = {
  'j': 'drum-bass',
  ' ': 'drum-tone',
  'k': 'drum-slap'
};
window.addEventListener('keydown', e => {
  if (e.repeat) return;
  const id = keyMap[e.key];
  if (id) {
    e.preventDefault();
    const el = document.getElementById(id);
    if (el) hitDrum(el);
  }
});

// ‚ïê‚ïê PATTERN RECORDER ‚ïê‚ïê
const BEATS = 16;
const bpm = 120;
let isRecording = false;
let recordStart = 0;
let recordedHits = [];
let pattern = { bass: [], tone: [], slap: [] };
let playTimeout = null;
let stepInterval = null;
let currentStep = 0;

// Build grid
function buildGrid() {
  ['bass', 'tone', 'slap'].forEach(drum => {
    const container = document.getElementById(`beats-${drum}`);
    container.innerHTML = '';
    pattern[drum] = Array(BEATS).fill(false);
    for (let i = 0; i < BEATS; i++) {
      const b = document.createElement('div');
      b.className = 'beat';
      b.setAttribute('data-beat', i);
      b.setAttribute('data-drum', drum);
      b.addEventListener('click', () => toggleBeat(drum, i));
      container.appendChild(b);
    }
  });
}

function toggleBeat(drum, i) {
  pattern[drum][i] = !pattern[drum][i];
  updateGrid();
}

function updateGrid() {
  ['bass', 'tone', 'slap'].forEach(drum => {
    const beats = document.querySelectorAll(`#beats-${drum} .beat`);
    beats.forEach((b, i) => {
      b.classList.toggle('on', pattern[drum][i]);
      b.classList.toggle('current', i === currentStep && stepInterval);
    });
  });
}

function startRecord() {
  if (!analyser) initAnalyser();
  isRecording = true;
  recordStart = Date.now();
  recordedHits = [];
  // Clear pattern
  ['bass', 'tone', 'slap'].forEach(d => pattern[d] = Array(BEATS).fill(false));
  updateGrid();
  document.getElementById('recDot').classList.add('recording');
  document.getElementById('recStatus').textContent = 'Recording‚Ä¶ tap your rhythm';
  // Auto-stop after 8 bars
  setTimeout(() => { if (isRecording) stopRecord(); }, (60000 / bpm) * BEATS * 2);
}

function stopRecord() {
  isRecording = false;
  document.getElementById('recDot').classList.remove('recording');
  document.getElementById('recStatus').textContent = `Recorded ${recordedHits.length} hits`;
  // Convert timed hits to grid
  const beatDur = 60000 / bpm;
  recordedHits.forEach(h => {
    const drumKey = h.drum.replace(/\d/g, '');
    if (!pattern[drumKey]) return;
    const beatIdx = Math.round(h.time / beatDur) % BEATS;
    pattern[drumKey][beatIdx] = true;
  });
  updateGrid();
}

function playPattern() {
  if (stepInterval) { clearInterval(stepInterval); stepInterval = null; }
  if (!analyser) initAnalyser();
  currentStep = 0;
  const stepMs = (60000 / bpm) / 4;

  // Map drum names to synthesiser params
  const drumParams = {
    bass: { freq: 80, type: 'triangle', name: 'bass' },
    tone: { freq: 200, type: 'sine', name: 'tone' },
    slap: { freq: 350, type: 'sawtooth', name: 'slap' }
  };

  stepInterval = setInterval(() => {
    ['bass', 'tone', 'slap'].forEach(drum => {
      if (pattern[drum][currentStep]) {
        const p = drumParams[drum];
        beatDrum(p.freq, p.type, p.name);
      }
    });
    currentStep = (currentStep + 1) % BEATS;
    updateGrid();
    if (currentStep === 0) {
      clearInterval(stepInterval);
      stepInterval = null;
      document.getElementById('recStatus').textContent = 'Playback complete';
    }
  }, stepMs);
  document.getElementById('recStatus').textContent = 'Playing‚Ä¶';
}

// ‚ïê‚ïê SAVE RHYTHM ‚ïê‚ïê
let savedRhythms = JSON.parse(localStorage.getItem('izwi-rhythms') || '[]');

function showSave() {
  const hasPattern = ['bass', 'tone', 'slap'].some(d => pattern[d].some(Boolean));
  if (!hasPattern) {
    alert('Record or tap a rhythm first, then save it to the circle.');
    return;
  }
  document.getElementById('saveModal').classList.add('show');
}
function hideSave() {
  document.getElementById('saveModal').classList.remove('show');
}

function saveRhythm() {
  const name = document.getElementById('rhythm-name').value.trim();
  if (!name) { document.getElementById('rhythm-name').focus(); return; }
  const instrument = document.getElementById('rhythm-instrument').value.trim();
  const rhythm = {
    name,
    instrument: instrument || 'Djembe',
    pattern: JSON.parse(JSON.stringify(pattern)),
    time: Date.now(),
    id: Math.random().toString(36).slice(2)
  };
  savedRhythms.unshift(rhythm);
  localStorage.setItem('izwi-rhythms', JSON.stringify(savedRhythms));
  hideSave();
  document.getElementById('rhythm-name').value = '';
  document.getElementById('rhythm-instrument').value = '';
  renderRhythms();
}

function renderRhythms() {
  const list = document.getElementById('rhythmsList');
  document.getElementById('commCount').textContent = `${savedRhythms.length} rhythm${savedRhythms.length !== 1 ? 's' : ''} saved`;

  if (savedRhythms.length === 0) {
    list.innerHTML = `<div style="font-family:'Cormorant Garamond',serif;font-size:1rem;font-style:italic;color:rgba(250,246,238,.25);text-align:center;padding:2rem;">
      The circle is waiting for its first rhythm. Record yours.
    </div>`;
    return;
  }

  list.innerHTML = '';
  savedRhythms.slice(0, 10).forEach((r, idx) => {
    const div = document.createElement('div');
    div.className = 'rhythm-item';
    const beatCols = ['on', 'on2', 'on3'];
    let patternHTML = '';
    for (let i = 0; i < BEATS; i++) {
      const hasBass = r.pattern.bass && r.pattern.bass[i];
      const hasTone = r.pattern.tone && r.pattern.tone[i];
      const hasSlap = r.pattern.slap && r.pattern.slap[i];
      const cls = hasBass ? 'on' : hasTone ? 'on2' : hasSlap ? 'on3' : '';
      patternHTML += `<div class="ri-beat ${cls}"></div>`;
    }
    const ago = timeAgo(r.time);
    div.innerHTML = `
      <div class="ri-play" onclick="playStoredRhythm(${idx})">
        <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      </div>
      <div class="ri-info">
        <div class="ri-name">${escHtml(r.name)}</div>
        <div class="ri-meta">${escHtml(r.instrument)} ¬∑ ${ago}</div>
      </div>
      <div class="ri-pattern">${patternHTML}</div>`;
    list.appendChild(div);
  });
}

function playStoredRhythm(idx) {
  if (stepInterval) { clearInterval(stepInterval); stepInterval = null; }
  if (!analyser) initAnalyser();
  const r = savedRhythms[idx];
  if (!r) return;
  // Load pattern
  pattern = JSON.parse(JSON.stringify(r.pattern));
  updateGrid();
  playPattern();
}

function timeAgo(ts) {
  const diff = Date.now() - ts;
  const m = Math.floor(diff / 60000);
  if (m < 1) return 'just now';
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60);
  if (h < 24) return `${h}h ago`;
  return `${Math.floor(h / 24)}d ago`;
}
function escHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// ‚ïê‚ïê DRUM SET SWITCHER ‚ïê‚ïê
document.querySelectorAll('.drum-tab').forEach(tab => {
  tab.addEventListener('click', function () {
    document.querySelectorAll('.drum-tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    const set = this.getAttribute('data-set');
    document.getElementById('djembe-set').style.display = 'none';
    document.getElementById('full-set').style.display = 'none';
    if (set === 'full') {
      document.getElementById('full-set').style.display = 'flex';
    } else {
      document.getElementById('djembe-set').style.display = 'flex';
    }
    // Re-bind
    document.querySelectorAll('.drum').forEach(drum => {
      drum.addEventListener('mousedown', () => hitDrum(drum));
      drum.addEventListener('touchstart', e => { e.preventDefault(); hitDrum(drum); }, { passive: false });
    });
  });
});

// ‚ïê‚ïê CURSOR ‚ïê‚ïê
const cur = document.getElementById('cur');
const ring = document.getElementById('ring');
let mx = 0, my = 0, rx = 0, ry = 0;
document.addEventListener('mousemove', e => {
  mx = e.clientX; my = e.clientY;
  cur.style.left = mx + 'px'; cur.style.top = my + 'px';
});
(function loop() {
  rx += (mx - rx) * .12; ry += (my - ry) * .12;
  ring.style.left = rx + 'px'; ring.style.top = ry + 'px';
  requestAnimationFrame(loop);
})();
document.querySelectorAll('a,button,input').forEach(el => {
  el.addEventListener('mouseenter', () => { ring.style.width = '50px'; ring.style.height = '50px'; });
  el.addEventListener('mouseleave', () => { ring.style.width = '36px'; ring.style.height = '36px'; });
});

// ‚ïê‚ïê INIT ‚ïê‚ïê
initAnalyser();
drawVis();
buildGrid();
renderRhythms();
</script>
</body>
</html>

